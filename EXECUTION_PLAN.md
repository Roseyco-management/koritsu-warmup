# Resend Domain Setup - Execution Plan

## Overview

This document provides a step-by-step execution plan to set up 12 domains with Resend for email warmup functionality. All necessary scripts have been created and are ready to run.

## What Has Been Created

### Scripts
1. **setup-resend-domains.js** - Complete domain setup in Resend (add domains, get DNS records, create webhooks)
2. **configure-vercel-dns.js** - Configure DNS records in Vercel for all domains
3. **setup-resend-webhooks.js** - Set up webhooks in Resend for all domains
4. **configure-vercel-env.js** - Configure environment variables in Vercel project

### Documentation
1. **RESEND_SETUP_GUIDE.md** - Comprehensive setup guide with troubleshooting
2. **EXECUTION_PLAN.md** - This file - step-by-step execution plan

### Configuration Files
- **.gitignore** - Updated to exclude webhook secrets file
- **resend-webhook-secrets.json** - Will be generated by webhook setup script (keep secure!)

## Prerequisites

Before running any scripts, ensure you have:

1. âœ… **Resend API Key**: `re_VqMqLX2o_HTHcbdfNvXgUeoVZ5wpFZCBf` (already in .env.local)
2. âš ï¸  **Vercel API Token**: Get from https://vercel.com/account/tokens
3. âœ… **Supabase Credentials**: Already configured in .env.local
4. âš ï¸  **Vercel Project Name**: The name of your Vercel project for this codebase

### Get Your Vercel Token

```bash
# 1. Go to https://vercel.com/account/tokens
# 2. Click "Create Token"
# 3. Name it "Domain Setup Script"
# 4. Set expiration (recommend 7 days for security)
# 5. Click "Create"
# 6. Copy the token
```

### Add Token to .env.local

```bash
echo "VERCEL_TOKEN=vercel_xxxxxxxxxxxxx" >> .env.local
```

## Execution Steps

### Step 1: Install Dependencies (if not already done)

```bash
npm install
```

### Step 2: Configure DNS Records in Vercel

This adds MX, SPF, and DMARC records to all 12 domains:

```bash
node configure-vercel-dns.js
```

**Expected Output:**
- âœ… MX record added for each domain
- âœ… SPF TXT record added for each domain
- âœ… DMARC TXT record added for each domain
- âš ï¸  Note about DKIM records needing manual addition

**Time:** ~2-3 minutes

### Step 3: Add Domains to Resend & Get DKIM Keys

This adds all domains to Resend and retrieves DNS configuration:

```bash
node setup-resend-domains.js
```

**What it does:**
- Adds each domain to Resend
- Retrieves DNS records (including unique DKIM keys)
- Displays DKIM keys for manual addition
- Creates webhooks for each domain

**Expected Output:**
- âœ… Each domain added to Resend
- ðŸ“‹ DKIM keys displayed for each domain
- âœ… Webhooks created for each domain
- ðŸ“„ Webhook secrets saved to `resend-webhook-secrets.json`

**Time:** ~3-5 minutes

### Step 4: Add DKIM Records to Vercel

**Manual Step Required:**

For each domain, you'll see output like:

```
Domain: kittyklub.co.uk
DKIM Key: p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQ...
```

**Option A - Via Script (Recommended):**

Create a file `dkim-keys.json`:

```json
{
  "kittyklub.co.uk": "p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQ...",
  "catcore.co.uk": "p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQ...",
  ...
}
```

Then run a helper script (I can create this if needed).

**Option B - Via Vercel Dashboard:**

1. Go to https://vercel.com/rosey-co-team/~/domains
2. For each domain:
   - Click the domain
   - Go to "DNS Records"
   - Click "Add Record"
   - Type: TXT
   - Name: `resend._domainkey`
   - Value: (paste the DKIM key from Step 3 output)
   - Click "Save"

**Time:** ~15-20 minutes (manual)

### Step 5: Set Up Webhooks

This creates webhooks in Resend for all domains:

```bash
node setup-resend-webhooks.js
```

**What it does:**
- Creates webhook for each domain pointing to `https://{domain}/api/webhooks/resend/warmup`
- Subscribes to all email events
- Saves webhook secrets to `resend-webhook-secrets.json`

**Expected Output:**
- âœ… Webhook created for each domain
- ðŸ“„ Secrets saved to JSON file
- âš ï¸  Warning to keep secrets secure

**Time:** ~2-3 minutes

### Step 6: Configure Environment Variables in Vercel

Update the project name in `configure-vercel-env.js` or set it via environment:

```bash
export VERCEL_PROJECT_NAME="your-project-name"
# or
# Edit configure-vercel-env.js and change PROJECT_NAME variable
```

Then run:

```bash
node configure-vercel-env.js
```

**What it configures:**
- RESEND_API_KEY
- RESEND_WEBHOOK_SECRET
- NEXT_PUBLIC_SUPABASE_URL
- NEXT_PUBLIC_SUPABASE_ANON_KEY
- SUPABASE_SERVICE_ROLE_KEY
- WARMUP_ENABLED
- WARMUP_CRON_SECRET
- WARMUP_DOMAINS (includes all 12 new domains)

**Expected Output:**
- âœ… All environment variables created/updated
- ðŸ“‹ Summary of successful/failed operations

**Time:** ~1 minute

### Step 7: Verify Domain Configuration

Wait for DNS propagation (can take 5 minutes to 48 hours):

```bash
# Check MX records
dig MX kittyklub.co.uk

# Check DKIM
dig TXT resend._domainkey.kittyklub.co.uk

# Check SPF
dig TXT kittyklub.co.uk | grep spf1

# Check DMARC
dig TXT _dmarc.kittyklub.co.uk
```

### Step 8: Verify Domains in Resend

1. Go to https://resend.com/domains
2. For each domain, click "Verify"
3. Wait for verification (usually instant if DNS is propagated)
4. Check that all domains show "Verified" status

### Step 9: Test Email Sending

Create a test script or use existing one:

```bash
# Modify test-bluepillar-receive.js to use new domains
node test-bluepillar-receive.js
```

Or create a quick test:

```javascript
const { Resend } = require('resend');
const resend = new Resend('re_VqMqLX2o_HTHcbdfNvXgUeoVZ5wpFZCBf');

resend.emails.send({
  from: 'warmup@kittyklub.co.uk',
  to: 'warmup@catcore.co.uk',
  subject: 'Test Email',
  text: 'Testing domain configuration',
});
```

### Step 10: Deploy to Vercel

```bash
vercel --prod
```

Or push to your Git repository to trigger automatic deployment.

## Domains Being Configured

1. kittyklub.co.uk
2. catcore.co.uk
3. clarityskin.store
4. duskglow.store
5. crypto-store.co
6. crypto-market.co
7. jesus-eternal.com
8. jesus-better.com
9. christianstore.co
10. cat-core.com
11. kitty-klub.com
12. muslimstore.co

## DNS Records Summary

Each domain will have these records added:

### Existing (Vercel managed)
- ALIAS @ â†’ Vercel
- ALIAS * â†’ Vercel
- CAA @ â†’ letsencrypt.org

### New (Resend email)
- MX @ â†’ feedback-smtp.us-east-1.amazonses.com (priority 10)
- TXT @ â†’ v=spf1 include:amazonses.com ~all
- TXT _dmarc â†’ v=DMARC1; p=none;
- TXT resend._domainkey â†’ (unique DKIM key per domain)

## Webhook Configuration

Each domain will have a webhook at:

```
https://kittyklub.co.uk/api/webhooks/resend/warmup
https://catcore.co.uk/api/webhooks/resend/warmup
https://clarityskin.store/api/webhooks/resend/warmup
... etc
```

**Webhook Events:**
- email.sent
- email.delivered
- email.delivery_delayed
- email.complained
- email.bounced
- email.opened
- email.clicked

## Verification Checklist

After completing all steps, verify:

- [ ] All 12 domains added to Resend
- [ ] All domains show "Verified" in Resend dashboard
- [ ] DNS records configured in Vercel (MX, SPF, DMARC, DKIM)
- [ ] Webhooks created for all domains
- [ ] Environment variables configured in Vercel project
- [ ] Test email sent successfully between two domains
- [ ] Webhook receives and processes email correctly
- [ ] Application deployed to Vercel

## Troubleshooting

### DNS Propagation Issues
```bash
# Check current DNS records
dig ANY kittyklub.co.uk

# Use Google DNS to check
dig @8.8.8.8 MX kittyklub.co.uk

# Check from different locations
# https://www.whatsmydns.net/
```

### Webhook Not Receiving Events
1. Check webhook URL is publicly accessible
2. Verify webhook secret matches in environment variables
3. Check Resend webhook delivery logs
4. Review application logs in Vercel

### Domain Verification Fails
1. Wait longer for DNS propagation (up to 48 hours)
2. Verify all DNS records are correct
3. Check for any conflicting DNS records
4. Use Resend's domain verification tool

## Security Reminders

- âš ï¸  **Never commit** `resend-webhook-secrets.json` to git
- âš ï¸  **Never commit** `.env.local` to git (already in .gitignore)
- âš ï¸  **Rotate tokens** periodically (every 90 days recommended)
- âš ï¸  **Use HTTPS** for all webhook endpoints
- âš ï¸  **Verify signatures** in webhook handlers

## Time Estimate

- **Automated Steps:** ~10-15 minutes
- **Manual DKIM Setup:** ~15-20 minutes
- **DNS Propagation:** 5 minutes - 48 hours
- **Testing & Verification:** ~30 minutes
- **Total:** ~1-2 hours (plus DNS propagation time)

## Support Resources

- **Resend Docs:** https://resend.com/docs
- **Vercel Docs:** https://vercel.com/docs
- **This Project:** See RESEND_SETUP_GUIDE.md for detailed troubleshooting

## Quick Start (TL;DR)

```bash
# 1. Add Vercel token to .env.local
echo "VERCEL_TOKEN=your_token" >> .env.local

# 2. Run all setup scripts
node configure-vercel-dns.js
node setup-resend-domains.js
node setup-resend-webhooks.js
node configure-vercel-env.js

# 3. Manually add DKIM records (see output from step 2)

# 4. Verify domains in Resend dashboard

# 5. Test and deploy
node test-bluepillar-receive.js
vercel --prod
```

## Questions?

Refer to `RESEND_SETUP_GUIDE.md` for detailed documentation and troubleshooting steps.
